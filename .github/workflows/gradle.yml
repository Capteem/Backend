name: Java CI with Gradle and CodeDeploy

env:
  AWS_REGION: ap-northeast-2
  S3_BUCKET_NAME: plog-action-bucket
  CODE_DEPLOY_APPLICATION_NAME: plog
  CODE_DEPLOY_DEPLOYMENT_GROUP_NAME: producion

on:
  push:
    branches: [ "feature" ]
  pull_request:
    branches: [ "develop"]

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # GitHub Actionsì—ì„œ Gradleì„ ìµœì ìœ¼ë¡œ ì‚¬ìš©í•˜ë„ë¡ êµ¬ì„±í•©ë‹ˆë‹¤.1
      # ìì„¸í•œ ë‚´ìš©ì€ https://github.com/gradle/actions/blob/main/setup-gradle/README.mdë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
      - name: Gradle ì„¤ì •
        uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0
        with:
          gradle-version: '8.7'

      # application.properties íŒŒì¼ì„ GitHub ì‹œí¬ë¦¿ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
      - name: application.properties ìƒì„±
        run: echo "${{secrets.APPLICATION_PROPERTIES}}" > src/main/resources/application.properties

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Gradle Wrapperë¡œ ë¹Œë“œ
        run: ./gradlew build

      - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v2
        with:
          name: plog
          path: build/libs

      - name: Make Directory
        run: mkdir -p deploy

          # appspec.yml íŒŒì¼ ë³µì‚¬
      - name: Copy appspec.yml
        run: cp appspec.yml ./deploy


      - name: ğŸ“¦ Zip project files
        run: zip -r ./$GITHUB_SHA.zip .

      - name : Access to Aws
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: S3 ì—…ë¡œë“œ
        run: aws s3 cp --region ${{ env.AWS_REGION }} ./$GITHUB_SHA.zip s3://${{ env.S3_BUCKET_NAME }}

      - name: AWS CodeDeployì— ë°°í¬
        run: |
          aws deploy create-deployment \
            --application-name ${{ env.CODE_DEPLOY_APPLICATION_NAME }} \
            --deployment-group-name ${{ env.CODE_DEPLOY_DEPLOYMENT_GROUP_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --s3-location bucket=${{ env.S3_BUCKET_NAME }},bundleType=zip,key=build/$GITHUB_SHA.zip
      
